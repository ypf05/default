#include<iostream>
#include<stdio.h>
#include<fstream>
#include<time.h>
#include<string.h>
#include<cstdlib>
using namespace std;
const int MAX=30;
const int N=30;
enum {False,True};
int Flag=False;
int Rec;

struct time
{
	int hour;
	int minute;
};
typedef struct 
{
	int number;
	struct time setout;
	char dPoint[MAX];
	char tPoint[MAX];
	float lastTime;
	int hFixed;
	int sFixed;
	int flag;
}ticket;
typedef struct
{
	ticket car[N];
}Car;

void mainMenu(Car*);
void search(Car*);
void searchByNum(Car*);
void searchByAdd(Car*);
void tickets(Car*);
Car* ticketOrder(Car*);
Car* ticketRefund(Car*);
void exit();
void showMessege(Car*);
void save(Car*);
void reserved(Car*);

int main()
{
	ifstream inFile;
	inFile.open("ticket.txt");
	if(!inFile.is_open())
	{
		cout<<"Could not open the file "<<endl;
		exit(EXIT_FAILURE);
	}
	Car *cars;
	cars=new Car;
	int i=1;
	while(inFile.good())
	{
		inFile>>cars->car[i].number>>cars->car[i].setout.hour>>cars->car[i].setout.minute>>cars->car[i].dPoint
			>>cars->car[i].tPoint>>cars->car[i].lastTime>>cars->car[i].hFixed>>cars->car[i].sFixed;
		cars->car[i].flag =0;
		i++;
	}
	Rec=i-1;
	do
	{
		mainMenu(cars);
	}while(Flag==False);
	return 0;
}

void mainMenu(Car* cars)
{
	char num;
	cout<<"		主菜单"<<endl;
	cout<<"================================================"<<endl;
	cout<<"		1.火车票信息查询\n";
	cout<<"		2.售票与退票\n";
	cout<<"		3.浏览班次信息\n";
	cout<<"		4.输出新班次信息到文件\n";
	cout<<"		5.退出系统\n";
	cout<<"================================================"<<endl;
	scanf("%c",&num);
	switch(num)
	{
	case '1':
		{
			search(cars);
			cout<<"\n按任意键返回菜单。。。\n"<<endl;
			getchar();
			getchar();
		}
		break;
	case '2':
		{
			tickets(cars);
			cout<<"\n按任意键返回菜单。。。\n"<<endl;
			getchar();
			getchar();
		}
		break;
	case '3':
		{
			showMessege(cars);
			cout<<"\n按任意键返回菜单。。。\n"<<endl;
			getchar();
			getchar();
		}
		break;
	case '4':
		{
			save(cars);
			cout<<"\n按任意键返回菜单。。。\n"<<endl;
			getchar();
			getchar();
		}
		break;
	case '5':
		{
			Flag=True;
			exit();
		}
		break;
	default:
		{
			cout<<"输入无效，请确保你的输入为\"1-5\""<<endl;
			cout<<"\n按任意键返回菜单。。。\n"<<endl;
			getchar();
			getchar();
		}
	}//switch ends
	Flag=False;

}
void search(Car* cars)
{
	char num;
	cout<<"		查询子菜单"<<endl;
	cout<<"================================================"<<endl;
	cout<<"		1.按班次查询\n";
	cout<<"		2.按终点站查询\n";
	cout<<"		3.返回\n";
	cout<<"================================================"<<endl;
	cin>>num;
	switch(num)
	{
	case '1':searchByNum(cars);break;
	case '2':searchByAdd(cars);break;
	case '3':;break;
	default:
		{
			cout<<"输入无效，请确保你的输入为\"1-3\""<<endl;
			cout<<"\n按任意键返回查询子菜单。。。\n"<<endl;
			getchar();
			search(cars);
		}
	}
}//switch ends
void searchByNum(Car* cars)
	{
		int num;
		cout<<"请输入要查询的班次号:";
		cin>>num;
		cout<<"班次\t发车时间\t起点\t终点\t行车时间(小时)\t剩余硬座量\t剩余硬卧量"<<endl;
		printf("%d\t%d:%d\t\t%s\t%s\t%.1f\t\t\t%d\t\t%d\n",cars->car[num].number,cars->car[num].setout.hour,
			cars->car[num].setout.minute,cars->car[num].dPoint,cars->car[num].tPoint,cars->car[num].lastTime,
			cars->car[num].hFixed,cars->car[num].sFixed);
	}
void searchByAdd(Car* cars)
	{
		char add[MAX];
		cout<<"请输入终点站名称:";
		cin>>add;
		int i,flag=0;
		for(i=1;i<=Rec;i++)
		{
			if(strcmp(add,cars->car[i].tPoint)==0)
			{
				cout<<"班次\t发车时间\t起点\t终点\t行车时间(小时)\t剩余硬座量\t剩余硬卧量"<<endl;
				printf("%d\t%d:%d\t\t%s\t%s\t%.1f\t\t\t%d\t\t%d\n",cars->car[i].number,cars->car[i].setout.hour,
					cars->car[i].setout.minute,cars->car[i].dPoint,cars->car[i].tPoint,cars->car[i].lastTime,
					cars->car[i].hFixed,cars->car[i].sFixed);
				flag=1;
				break;
			}
		}
		if(flag==0)
			cout<<"查询不到此终点站"<<endl;
	}
void tickets(Car* cars)
{
	char num;
	cout<<"              订票与退票菜单"<<endl;
	cout<<"================================================"<<endl;
	cout<<"		1.订票\n";
	cout<<"		2.退票\n";
	cout<<"		3.已订的票\n";
	cout<<"		4.返回\n";
	cout<<"================================================"<<endl;
	cin>>num;
	switch(num)
	{
	case '1':ticketOrder(cars);break;
	case '2':ticketRefund(cars);break;
	case '3':reserved(cars);break;
	case '4':break;
	default:
		{
			cout<<"输入无效，请确保你的输入为\"1-3\""<<endl;
			cout<<"\n按任意键返回订票与退票菜单。。。\n"<<endl;
			getchar();
			mainMenu(cars);
		}
	}
}//switch ends
Car* ticketOrder(Car* cars)
{
	int i,j;
	showMessege(cars);
	cout<<"请输入要订购车票的班次:";
	cin>>i;
	if(i<1||i>Rec)
	{
		cout<<"对不起，今天没有这辆车"<<endl;
		cout<<"按任意键返回菜单 。。"<<endl;
		getchar();
		tickets(cars);
	}
	time_t now_time=time(NULL);
	tm* now=localtime(&now_time);
	if((now->tm_hour==cars->car[i].setout.hour&&now->tm_min>cars->car[i].setout .minute )
		||(now->tm_hour>cars->car[i].setout .hour ))
		cout<<"对不起今天这趟车已发出，请明天再来。"<<endl;
	else if(cars->car[i].flag !=0)
		cout<<"您已订票，如要更换软硬座，请先退票"<<endl;
	else
		{
			cout<<"硬座余票:"<<cars->car[i].hFixed<<endl;
			cout<<"硬卧余票:"<<cars->car[i].sFixed<<endl<<endl;
			cout<<"订购硬座请选1\n订购硬卧请选2\n其他任意键退出\n";
			cin>>j;
			if((j==1&&cars->car[i].hFixed==0)||(j==2&&cars->car[i].sFixed==0))
				cout<<"很抱歉，票已售罄\n";
			else
			{
				if(j==1&&cars->car[i].hFixed >0)
				{
					cars->car[i].hFixed --;
					cars->car[i].flag =1;
					cout<<"你已订票成功，请在规定时间内上车\n";
					cout<<"班次\t发车时间\t起点\t终点\t行车时间(小时)"<<endl;
					printf("%d\t%d:%d\t\t%s\t%s\t%.1f\t\t",cars->car[i].number,cars->car[i].setout.hour,
					cars->car[i].setout.minute,cars->car[i].dPoint,cars->car[i].tPoint,cars->car[i].lastTime);
					cout<<"硬座"<<endl;
				}
				else if(j==2&&cars->car[i].sFixed >0)
					{
						cars->car[i].sFixed --;
						cars->car[i].flag =2;
						cout<<"你已订票成功，请在规定时间内上车\n";
						cout<<"班次\t发车时间\t起点\t终点\t行车时间(小时)"<<endl;
						printf("%d\t%d:%d\t\t%s\t%s\t%.1f\t",cars->car[i].number,cars->car[i].setout.hour,
							cars->car[i].setout.minute,cars->car[i].dPoint,cars->car[i].tPoint,cars->car[i].lastTime);
						cout<<"硬卧"<<endl;
					}
			}
		}
	return cars;
}
Car* ticketRefund(Car* cars)
{
	int i;
	cout<<"请输入要退购车票的班次:";
	cin>>i;
	time_t now_time=time(NULL);
	tm* now=localtime(&now_time);
	if(cars->car[i].flag ==0)
	{
		cout<<"您未购买本趟车次\n";
		getchar();
	}
	else if((now->tm_hour==cars->car[i].setout.hour&&now->tm_min<cars->car[i].setout .minute )
		||(now->tm_hour<cars->car[i].setout .hour ))
	{
		if(cars->car[i].flag ==1)
		{
			cars->car[i].hFixed ++;
		}
		else if(cars->car[i].flag ==2)
		{
			cars->car[i].sFixed ++;
		}
		cout<<"退订车票成功，谢谢使用!"<<endl;
		cout<<"班次\t发车时间\t起点\t终点\t行车时间(小时)\t剩余硬座量\t剩余硬卧量"<<endl;
		printf("%d\t%d:%d\t\t%s\t%s\t%.1f\t\t\t%d\t\t%d\n",cars->car[i].number,cars->car[i].setout.hour,
			cars->car[i].setout.minute,cars->car[i].dPoint,cars->car[i].tPoint,cars->car[i].lastTime,
			cars->car[i].hFixed,cars->car[i].sFixed);
		if(cars->car[i].flag ==1)
		{
			cars->car[i].hFixed ++;
			cout<<"硬座"<<endl;
		}
		else if(cars->car[i].flag ==2)
		{
			cars->car[i].sFixed ++;
			cout<<"硬卧"<<endl;
		}
		cars->car[i].flag=0;
	}
	else
		cout<<"已发车，不能退票，谢谢合作"<<endl;
	return cars;
}
void reserved(Car* cars)
{
	int i,flag=0;
	cout<<"班次\t发车时间\t起点\t终点\t行车时间(小时)"<<endl;
	for(i=1;i<=Rec;i++)
	{
		if(cars->car[i].flag !=0)
		{
			printf("%d\t%d:%d\t\t%s\t%s\t%.1f\t\t",cars->car[i].number,cars->car[i].setout.hour,
					cars->car[i].setout.minute,cars->car[i].dPoint,cars->car[i].tPoint,cars->car[i].lastTime);
			if(cars->car[i].flag ==1)
				cout<<"硬座"<<endl;
			else if(cars->car[i].flag ==2)
				cout<<"硬卧"<<endl;
			flag=1;
		}
	}
	if(flag==0)
		cout<<"您未订购任何班次"<<endl;
}
void exit()
{
	cout<<"\n\n****************谢谢使用本系统******************\n";
	exit(0);
}
void showMessege(Car* cars)
{
	int i=1;
	cout<<"************************************本日时刻表************************************"<<endl;
	cout<<"班次\t发车时间\t起点\t终点\t行车时间(小时)\t剩余硬座量\t剩余硬卧量"<<endl;
	for(i=1;i<=Rec;i++)
	{
		printf("%d\t%d:%d\t\t%s\t%s\t%.1f\t\t\t%d\t\t%d\n",cars->car[i].number,cars->car[i].setout.hour,
			cars->car[i].setout.minute,cars->car[i].dPoint,cars->car[i].tPoint,cars->car[i].lastTime,
			cars->car[i].hFixed,cars->car[i].sFixed);
	}
	cout<<endl;
}
void save(Car* cars)
{
	ofstream outFile;
	outFile.open("final.txt");
	int i=1;
	for(i=1;i<=Rec;i++)
	{
		outFile<<" "<<cars->car[i].number<<" "<<cars->car[i].setout.hour<<" "<<
			cars->car[i].setout.minute<<" "<<cars->car[i].dPoint<<" "<<cars->car[i].tPoint<<" "<<cars->car[i].lastTime<<" "<<
			cars->car[i].hFixed<<" "<<cars->car[i].sFixed<<" "<<endl;
	}
	cout<<"已保存到文件\"final.txt\""<<endl;
}

